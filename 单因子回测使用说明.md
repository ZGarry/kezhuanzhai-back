# 可转债单因子回测分析工具使用说明

## 概述

本工具包提供了完整的可转债单因子回测分析功能，可以对32个不同的因子进行独立回测，并生成详细的分析报告。

## 文件说明

### 核心文件

1. **`single_factor_backtest.py`** - 完整的单因子回测分析工具
   - 支持所有32个因子的完整回测
   - 生成详细的分析报告和可视化图表
   - 支持并行处理
   - 推荐用于正式的因子分析

2. **`quick_factor_test.py`** - 快速因子测试工具
   - 测试10个主要因子
   - 快速验证因子效果
   - 适合初步筛选和测试

3. **`generate_factor_configs.py`** - 配置文件生成器
   - 为所有因子生成标准化配置文件
   - 生成批量运行脚本
   - 生成因子汇总信息

4. **`run_batch_backtest.py`** - 批量回测脚本（自动生成）
   - 使用配置文件批量运行所有因子回测
   - 自动生成汇总结果

### 配置目录

- **`configs/single_factors/`** - 包含所有因子的配置文件
  - 每个因子对应一个JSON配置文件
  - `factors_summary.json` - 因子信息汇总
  - `factors_summary.txt` - 因子信息文本版

## 使用方法

### 方法一：快速测试（推荐新用户）

```bash
python quick_factor_test.py
```

这会测试10个主要因子，快速了解不同因子的表现：
- 收盘价、转股溢价率、到期收益率、双低因子
- 纯债溢价率、换手率、成交额、剩余规模
- 剩余年限、市盈率

### 方法二：完整因子分析

```bash
python single_factor_backtest.py
```

这会运行所有32个因子的完整回测分析：
- 串行执行所有因子回测
- 生成详细的分析报告
- 包含可视化图表
- 按因子分类进行统计分析

### 方法三：批量配置运行

1. 首先生成配置文件：
```bash
python generate_factor_configs.py
```

2. 然后运行批量回测：
```bash
python run_batch_backtest.py
```

或在Windows下直接双击：
```
run_batch_backtest.bat
```

## 因子分类

### 1. 价格类因子 (5个)
- **收盘价** (close) - 转债收盘价，权重-1.0（价格越低越好）
- **开盘价** (open) - 转债开盘价，权重-1.0
- **最高价** (high) - 转债最高价，权重-1.0
- **最低价** (low) - 转债最低价，权重-1.0
- **涨跌幅** (pct_chg) - 当日涨跌幅，权重1.0（动量效应）

### 2. 转债特性因子 (6个)
- **转股溢价率** (conv_prem) - 转债价格与转股价值的溢价率，权重-1.0
- **理论溢价率** (theory_conv_prem) - 理论转股溢价率，权重-1.0
- **修正溢价率** (mod_conv_prem) - 修正转股溢价率，权重-1.0
- **纯债溢价率** (bond_prem) - 转债价格与纯债价值的溢价率，权重-1.0
- **到期收益率** (ytm) - 转债到期收益率，权重1.0
- **双低因子** (dblow) - 转股溢价率和收盘价的综合指标，权重-1.0

### 3. 市场活跃度因子 (3个)
- **成交量** (vol) - 当日成交量，权重1.0
- **成交额** (amount) - 当日成交额，权重1.0
- **换手率** (turnover) - 当日换手率，权重1.0

### 4. 规模因子 (4个)
- **剩余规模** (remain_size) - 债券剩余规模，权重1.0
- **剩余市值** (remain_cap) - 债券剩余市值，权重1.0
- **发行规模** (issue_size) - 债券发行规模，权重1.0
- **转债市占比** (cap_mv_rate) - 转债市值占比，权重1.0

### 5. 时间因子 (2个)
- **剩余年限** (left_years) - 债券剩余年限，权重1.0
- **上市天数** (list_days) - 债券上市天数，权重1.0

### 6. 价值因子 (4个)
- **纯债价值** (pure_value) - 债券纯债价值，权重1.0
- **理论价值** (theory_value) - 债券理论价值，权重1.0
- **期权价值** (option_value) - 转债期权价值，权重1.0
- **理论偏离度** (theory_bias) - 实际价格与理论价值的偏离度，权重-1.0

### 7. 正股相关因子 (8个)
- **市盈率TTM** (pe_ttm) - 正股市盈率TTM，权重-1.0
- **市净率** (pb) - 正股市净率，权重-1.0
- **市销率TTM** (ps_ttm) - 正股市销率TTM，权重-1.0
- **总市值** (total_mv) - 正股总市值，权重1.0
- **流通市值** (circ_mv) - 正股流通市值，权重1.0
- **正股波动率** (volatility_stk) - 正股年化波动率，权重-1.0
- **正股收盘价** (close_stk) - 正股收盘价，权重1.0
- **正股涨跌幅** (pct_chg_stk) - 正股当日涨跌幅，权重1.0

## 回测参数设置

### 默认参数
- **回测期间**：2020-01-01 到 2024-12-31
- **初始资金**：100万元
- **持仓数量**：10只可转债
- **再平衡频率**：每日

### 过滤条件
- **剩余年限** > 0.5年
- **上市天数** > 30天

### 权重说明
- **正权重 (1.0)**：指标值越大越好（如收益率、成交量）
- **负权重 (-1.0)**：指标值越小越好（如价格、溢价率）

## 结果输出

### 1. 快速测试结果
- `results/quick_test/quick_test_results.csv` - 测试结果汇总
- `results/quick_test/quick_report.txt` - 简要报告

### 2. 完整分析结果
- `results/single_factor_analysis/factor_backtest_results.csv` - 详细结果
- `results/single_factor_analysis/summary_report.txt` - 汇总报告
- `results/single_factor_analysis/factor_analysis_charts.png` - 可视化图表
- `results/single_factor_analysis/category_analysis_charts.png` - 分类分析图表
- `results/single_factor_analysis/category_analysis.csv` - 分类统计

### 3. 单个因子结果
每个因子的详细结果保存在：
- `results/single_factor/{factor_id}/` - 因子详细回测结果
- 包含净值曲线、交易记录、持仓分析等

## 性能指标说明

- **年化收益率**：策略的年化投资收益率
- **最大回撤**：投资期间的最大亏损幅度
- **夏普比率**：风险调整后的收益指标
- **胜率**：获利交易占总交易的比例
- **交易次数**：回测期间的总交易次数

## 最佳实践

1. **首次使用**：建议先运行快速测试了解基本效果
2. **因子筛选**：关注年化收益率、夏普比率和最大回撤的综合表现
3. **分类分析**：不同类别因子可能在不同市场环境下表现不同
4. **参数调整**：可以修改配置文件调整回测参数
5. **组合策略**：表现优异的单因子可以考虑组合使用

## 注意事项

1. 回测结果仅供参考，不代表未来表现
2. 实际交易中需要考虑交易成本、滑点等因素
3. 建议结合市场环境和其他分析方法使用
4. 定期更新数据和重新评估因子有效性

## 故障排除

1. **数据文件不存在**：确保 `data/cb_data.pq` 文件存在
2. **内存不足**：可以使用快速测试或减少并行数量
3. **运行时间过长**：完整分析需要较长时间，建议耐心等待
4. **结果异常**：检查数据质量和参数设置

## 扩展功能

如需扩展功能，可以：
1. 添加新的因子定义
2. 修改过滤条件
3. 调整权重设置
4. 增加新的评估指标
5. 自定义可视化图表 